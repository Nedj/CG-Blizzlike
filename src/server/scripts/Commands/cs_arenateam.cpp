/*
* Copyright (C) 2008-2011 TrinityCore <http://www.trinitycore.org/>
*
* This program is free software; you can redistribute it and/or modify it
* under the terms of the GNU General Public License as published by the
* Free Software Foundation; either version 2 of the License, or (at your
* option) any later version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
* FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
* more details.
*
* You should have received a copy of the GNU General Public License along
* with this program. If not, see <http://www.gnu.org/licenses/>.
*/

/* ScriptData
Name: arenateam_commandscript
%Complete: 100
Comment: Arena Team Commands
Category: commandscripts
EndScriptData */

#include "ScriptMgr.h"
#include "ArenaTeam.h"
#include "ArenaTeamMgr.h"
#include "Chat.h"

class arenateam_commandscript : public CommandScript
{
public:
    arenateam_commandscript() : CommandScript("arenateam_commandscript") { }

    ChatCommand* GetCommands() const
    {
        static ChatCommand arenateamCommandTable[] =
        {
            { "disband",         SEC_GAMEMASTER,  false,  &HandleArenaTeamDisbandCommand,     "", NULL },
            //{ "rename",          SEC_GAMEMASTER,  false,  &HandleArenaTeamRenameCommand,      "", NULL },
            { "lookup",          SEC_GAMEMASTER,  false,  &HandleArenaTeamLookupCommand,      "", NULL },
            { "setcaptain",       SEC_GAMEMASTER,  false,  &HandleArenaTeamSetCaptainCommand,  "", NULL },
            { "info",             SEC_GAMEMASTER,  false,  &HandleArenaTeamInfoCommand,         "", NULL },
            { NULL,              0,               false,  NULL,                               "", NULL }
         };
         static ChatCommand commandTable[] =
         {
             { "arenateam",      SEC_GAMEMASTER,  false, NULL,            "", arenateamCommandTable },
             { NULL,             0,                  false, NULL,                               "", NULL }
         };
         return commandTable;
    }

    static bool HandleArenaTeamDisbandCommand(ChatHandler* handler, const char *args)
    {
        if (!*args)
            return false;

        uint32 teamid = atoi((char*)args);
        if (!teamid)
            return false;

            ArenaTeam *at = sArenaTeamMgr->GetArenaTeamById(teamid);

        if (!at)
        {
            handler->PSendSysMessage(LANG_AT_NOT_EXIST, teamid);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (at->IsFighting())
        {
            handler->SendSysMessage(LANG_AT_IS_FIGHTING);
            handler->SetSentErrorMessage(true);
            return false;
        }

        at->Disband(handler->GetSession());
        handler->PSendSysMessage(LANG_AT_DISBAND_SUCCESS, at->GetName().c_str());
        return true;
    }

    /*static bool HandleArenaTeamRenameCommand(ChatHandler* handler, const char* args)
    {
        if (!*args)
           return false;

        char* argName;
        char* idStr;
        handler->extractOptFirstArg((char*)args, &idStr, &argName);
        if (!idStr)
            return false;

        char* nameStr = extractQuotedArg(argName);
        if (!nameStr)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
            return false;

        uint32 teamid = atoi(idStr);
        if (!teamid)
            return false;

        std::string newteam = nameStr;

        ArenaTeam *at = sArenaTeamMgr->GetArenaTeamById(teamid);

        if (newteam.length() > 24)
        {
            handler->SendSysMessage(LANG_AT_RENAME_MAX);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (!at)
        {
            handler->PSendSysMessage(LANG_AT_NOT_EXIST, teamid);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (at->IsFighting())
        {
            handler->SendSysMessage(LANG_AT_IS_FIGHTING);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (strcmp(at->GetName().c_str(), newteam.c_str()) == 0)
        {
            handler->SendSysMessage(LANG_AT_RENAME_EQUAL);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (sArenaTeamMgr->GetArenaTeamByName(newteam))
        {
            handler->PSendSysMessage(LANG_AT_ALREADY_EXIST, newteam.c_str());
            handler->SetSentErrorMessage(true);
            return false;
        }

        std::string teamname = at->GetName();
        CharacterDatabase.DirectPExecute("UPDATE arena_team SET name = '%s' WHERE arenaTeamId = '%d'", newteam.c_str(), teamid);

        QueryResult result = CharacterDatabase.PQuery("SELECT arenaTeamId, name, captainGuid, type, backgroundColor, emblemStyle, emblemColor, borderStyle, borderColor, rating, weekGames, weekWins, seasonGames, seasonWins, rank FROM arena_team WHERE arenaTeamId = %d", teamid);
        at->LoadArenaTeamFromDB(result);

        /*ArenaTeam::MemberList::iterator itr = at->m_membersBegin();
        for (; itr != at->m_membersEnd(); ++itr)
        {
            if(Player *player = sObjectMgr->GetPlayer(itr->Guid))
                if (!handler->HasLowerSecurity(player, 0))
                    player->GetSession()->KickPlayer();
        }*/

        /*handler->PSendSysMessage(LANG_AT_RENAME_SUCCESS, teamname.c_str(), newteam.c_str());
        return true;
    }*/

    static bool HandleArenaTeamLookupCommand(ChatHandler* handler, const char* args)
    {
        if (!*args)
            return false;

        std::string namepart = args;
        std::wstring wnamepart;

        if (!Utf8toWStr(namepart, wnamepart))
            return false;

        wstrToLower(wnamepart);

        bool found = false;
        ArenaTeamMgr::ArenaTeamContainer::const_iterator i = sArenaTeamMgr->GetArenaTeamMapBegin();
        for (; i != sArenaTeamMgr->GetArenaTeamMapEnd(); ++i)
        {
            ArenaTeam *at = i->second;

            if (Utf8FitTo(at->GetName(), wnamepart))
            {
                uint32 teamid = at->GetId();

                if (handler->GetSession())
                    handler->PSendSysMessage(LANG_AT_LIST, at->GetId(), at->GetType(), at->GetName().c_str());

                    if (!found)
                        found = true;

                        continue;
             }
        }

        if (!found)
            handler->PSendSysMessage(LANG_AT_NOT_FOUND, namepart.c_str());

        return true;
    }

    static bool HandleArenaTeamSetCaptainCommand(ChatHandler* handler, const char* args)
    {
        if (!*args)
           return false;

        char* idStr;
        char* nameStr;
        handler->extractOptFirstArg((char*)args, &idStr, &nameStr);
        if (!idStr)
            return false;

        uint32 teamid = atoi(idStr);
        if (!teamid)
            return false;

        Player* target;
        uint64 target_guid;
        if (!handler->extractPlayerTarget(nameStr, &target, &target_guid))
            return false;

        ArenaTeam *at = sArenaTeamMgr->GetArenaTeamById(teamid);  

        if (!at)
        {
            handler->PSendSysMessage(LANG_AT_NOT_EXIST, teamid);
            handler->SetSentErrorMessage(true);
            return false;
        }

        if (!target)
        {
            handler->PSendSysMessage(LANG_AT_PLAYER_NOT_EXIST, nameStr);
            handler->SetSentErrorMessage(true);
            return false;
        }        

        if (at->IsFighting())
        {
            handler->SendSysMessage(LANG_AT_IS_FIGHTING);
            handler->SetSentErrorMessage(true);
            return false;
        }
        
        if(!at->IsMember(target_guid))
        {
            handler->PSendSysMessage(LANG_AT_NOT_MEMBER, nameStr, at->GetName().c_str());
            handler->SetSentErrorMessage(true);
            return false;        
        } 

        if(at->GetCaptain() == target_guid)
        {
            handler->PSendSysMessage(LANG_AT_ALREADY_CAPTAIN, nameStr, at->GetName().c_str());
            handler->SetSentErrorMessage(true);
            return false;        
        }


        Player* oldCaptain = sObjectAccessor->FindPlayer(at->GetCaptain());
        at->SetCaptain(target_guid);
        handler->PSendSysMessage(LANG_AT_CAPTAIN_SUCCESS, at->GetName().c_str(), oldCaptain->GetName(), nameStr);
        return true;
    }

    static bool HandleArenaTeamInfoCommand(ChatHandler* handler, const char* args)
    {
        if (!*args)
            return false;

        uint32 teamid = atoi((char*)args);
        if (!teamid)
            return false;

        ArenaTeam *at = sArenaTeamMgr->GetArenaTeamById(teamid); 

        if (!at)
        {
            handler->PSendSysMessage(LANG_AT_NOT_EXIST, teamid);
            handler->SetSentErrorMessage(true);
            return false;
        }

        handler->PSendSysMessage(LANG_AT_INFO_TEAM, at->GetName().c_str(), at->GetRating(), at->GetType());
        for (ArenaTeam::MemberList::iterator itr = at->m_membersBegin(); itr != at->m_membersEnd(); ++itr)
        {
            handler->PSendSysMessage(LANG_AT_INFO_MEMBER, GUID_LOPART(itr->Guid), itr->Name.c_str(), itr->PersonalRating, (at->GetCaptain() == itr->Guid ? "- *" : ""));
        }
        return true;
    }
};
    void AddSC_arenateam_commandscript()
    {
        new arenateam_commandscript();
    }
